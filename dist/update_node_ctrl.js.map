{"version":3,"sources":["../src/update_node_ctrl.js"],"names":["updateNode","node","allData","panelCtrl","data","prepareModalData","utils","showModal","removeListeners","addListeners","msg","self","maxlength","type","filter","d","category_id","reduce","arr","record","push","info","category","reason_id","parent_reason_id","parent","Array","from","Set","inputVal","name","$","document","off","on","input","serializeArray","value","isInputValid","startUpdate","alert","toLowerCase","indexOf","isInputValidSecondCheck","url","writeLine","line","makeLine","postgresUrl","postgRestHost","childUrl","childLine","updateForReasons","normalUpdate","update","then","trigger","refresh","catch","console","log","e","l","reasons","getReasons"],"mappings":"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","file":"update_node_ctrl.js","sourcesContent":["import * as utils from './utils'\n\nlet filter = []\n\nexport function updateNode (node, allData, panelCtrl) {\n  let data = prepareModalData(node, allData)\n  utils.showModal('update_node.html', data)\n  removeListeners()\n  addListeners(node, allData, panelCtrl)\n}\n\n/**\n * Update the reminder text based on the node's type\n * filter the distinct record of the same branch based on the node's type and push the value that match that type in the record to an array, this is for further validation purposes\n * @param {*} node \n * @param {*} allData \n */\nfunction prepareModalData (node, allData) {\n\n  let msg\n  let self\n  let maxlength = 50\n\n if (node.type === 'Category') {\n    self = 'Category'\n    filter = allData.filter(d => d.category_id !== null)\n    filter = filter.reduce((arr, record) => {\n      arr.push(record.category_id)\n      return arr\n    }, [])\n  } else if (node.type === 'Parent Reason') {\n    self = 'Reason'\n    filter = allData.filter(d => d.category_id === node.info.category && d.reason_id !== null && d.parent_reason_id === null )\n    filter = filter.reduce((arr, record) => {\n      arr.push(record.reason_id)\n      return arr\n    }, [])\n  } else if (node.type === 'Reason') {\n    self = 'Sub-Reason'\n    filter = allData.filter(d => d.category_id === node.info.category && d.reason_id !== null && d.parent_reason_id === node.parent)\n    filter = filter.reduce((arr, record) => {\n      arr.push(record.reason_id)\n      return arr\n    }, [])\n  } \n\n  filter = Array.from(new Set(filter))\n\n  return {\n    info: {self: self},\n    inputVal: node.name,\n    maxlength: maxlength\n  }\n}\n\nfunction removeListeners () {\n  $(document).off('click', '#master-data-reason-code-update-node-submitBtn')\n}\n\nfunction addListeners (node, allData, panelCtrl) {\n  $(document).on('click', '#master-data-reason-code-update-node-submitBtn', e => {\n    const input = $('#master-data-reason-code-update-node-form').serializeArray()[0].value\n    if (isInputValid(input, node)) {\n      //valid\n      startUpdate(input, node, panelCtrl, allData)\n\n    }\n  })\n}\n\n/**\n * Check if input is empty\n * Check if input has changed\n * Check if input is already exist within the same parent\n * @param {*} input \n * @param {*} node \n */\nfunction isInputValid(input, node) {\n\n  if (input === '') {\n    utils.alert('warning', 'Warning', 'Input Required')\n    return false\n  }\n\n  if (input === node.name) {\n    utils.alert('warning', 'Warning', 'Change Required')\n    return false\n  }\n\n  filter = filter.reduce((arr, d) => {\n    arr.push(d.toLowerCase())\n    return arr\n  }, [])\n\n  // console.log(filter);\n  \n  if (filter.indexOf(input.toLowerCase()) !== -1) {\n    utils.alert('warning', 'Warning', node.type + ' exists')\n    return false\n  }\n\n  if (input.indexOf('|') !== -1){\n    utils.alert('warning', 'Warning', 'Sensitive character \"|\" is not allowed')\n    return false\n  }\n\n  return true\n}\n\n/**\n * Prepare urls and lines for the update\n * @param {*} input \n * @param {*} node \n * @param {*} panelCtrl \n */\nfunction startUpdate(input, node, panelCtrl, allData) {\n\n  if (!isInputValidSecondCheck(input, node, allData)) {return}\n  \n  const url = utils.writeLine(node)\n  const line = makeLine(input, node)\n\n  if (node.type === 'Parent Reason' || node.type === 'Reason') {\n    let postgresUrl = utils.postgRestHost + 'reason_codes?category_id=eq.' + node.info.category\n    const childUrl = postgresUrl += '&reason_id=not.is.null' + '&parent_reason_id=eq.' + node.name\n    const childLine = 'parent_reason_id=' + input\n    updateForReasons(url, line, childUrl, childLine, panelCtrl)\n  }else{\n    normalUpdate(url, line, panelCtrl)\n  }\n}\n\n/**\n * Url will locate all records matching this url condition\n * Line is the update argument that is used to update all those records\n * popup successful, close the form, and refresh the tree when it's finished\n * popup error, close the form when it failed\n * @param {*} url \n * @param {*} line \n * @param {*} panelCtrl \n */\nfunction normalUpdate(url, line, panelCtrl) {\n  utils.update(url, line).then(res => {\n    // console.log(res)\n    $('#master-data-reason-code-update-node-cancelBtn').trigger('click')\n    utils.alert('success', 'Success', 'A new node has been succeesfully inserted')\n    panelCtrl.refresh()\n  }).catch(e => {\n    // console.log(e)\n    $('#master-data-reason-code-update-node-cancelBtn').trigger('click')\n    utils.alert('error', 'Error', 'Error ocurred whiling inserting node into the database, please try agian')\n  })\n}\n\n/**\n * Url will locate the selected parent_reason or reason, line is the update argument\n * update the reason's reason_id, and then locate all its children, then update the children's parent_reason_id\n * popup successful, close the form, and refresh the tree when it's finished\n * popup error, close the form when it failed\n * @param {*} url \n * @param {*} line \n * @param {*} childUrl \n * @param {*} childLine \n * @param {*} panelCtrl \n */\nfunction updateForReasons(url, line, childUrl, childLine, panelCtrl){\n  utils.update(url, line).then(utils.update(childUrl, childLine).then(res => {\n    //   console.log(res)\n      $('#master-data-reason-code-update-node-cancelBtn').trigger('click')\n      utils.alert('success', 'Success', 'A new node has been succeesfully inserted')\n      panelCtrl.refresh()\n    })).catch(e => {\n      console.log(e)\n      $('#master-data-reason-code-update-node-cancelBtn').trigger('click')\n      utils.alert('error', 'Error', 'Error ocurred whiling inserting node into the database, please try agian')\n    })\n  }\n\n/**\n * Make the update line based on the node type.\n * @param {*} input \n * @param {*} node \n */\nfunction makeLine(input, node){\n  let l = ''\n  if (node.type === 'Category') {\n    l = 'category_id=' + input\n  }else if (node.type === 'Parent Reason' || node.type === 'Reason') {\n    l = 'reason_id=' + input\n  }\n  return l\n}\n\nfunction isInputValidSecondCheck(input, node, allData) {\n\n  if (node.type === 'Parent Reason' || node.type === 'Reason') {\n    //get all of the reasons of that category\n    const reasons = utils.getReasons(node, allData)\n    if (reasons.indexOf(input) !== -1) {\n      //exist\n      utils.alert('warning', 'Warning', \"Same reason was found in the same category, please make sure there isn't duplicate reason in the same category\")\n      return false\n    }\n  }\n\n  if (input === node.parent) {\n    utils.alert('warning', 'Warning', \"The name cannot be the same as its parent's name\")\n    return false\n  }\n\n  return true\n}\n"]}